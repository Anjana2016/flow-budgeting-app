<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üíö Flow Budgeting - Your Financial Freedom</title>
    
    <!-- 
    VERSION: 2.5.2-stash-activation-partial ‚úÖ
    STATUS: FLOW SYSTEM + MULTIPLES OF 5 + CORRECT SAVE CATEGORY + DAYS CALCULATION + STASH AUTO-ACTIVATION (Steps 1-4)
    DATE: July 01, 2025
    
    NEW FEATURES (v2.5.2-partial):
    ‚úÖ STASH Auto-Activation System - Core functionality implemented (Steps 1-4)
    ‚úÖ Emergency Mode State Management - stashActivated and stashAvailable tracking
    ‚úÖ activateStashMode() Function - Automatic emergency fund activation
    ‚úÖ updateStashModeDisplays() Function - Emergency UI indicators
    ‚úÖ Enhanced Daily Flow Calculation - STASH-aware calculation logic
    
    PREVIOUS FEATURES (v2.5.1):
    ‚úÖ calculateDaysRemaining() Function Added - Enterprise-grade days calculation
    ‚úÖ Division by Zero Protection - Math.max(1, daysLeft) safeguard
    ‚úÖ Documentation Added - Clear function purpose and edge case handling
    
    PREVIOUS FEATURES (v2.5):
    ‚úÖ SAVE Category - Correctly named and positioned (was "Sustain")
    ‚úÖ Wealth Building Focus - SAVE category now represents long-term wealth building
    ‚úÖ Savings-Focused Examples - Emergency fund, investments, retirement planning
    ‚úÖ Proper 4 S's Framework - SECURE, SAVE, STASH, SPEND alignment complete
    ‚úÖ Universal Multiples of 5 Rounding - All amounts rounded to nearest $5
    ‚úÖ Rounding Feedback System - Shows original amount when rounded
    ‚úÖ Updated Quick Actions - All preset amounts are multiples of 5
    ‚úÖ Daily Flow Rounding - $35 precisely, all calculations rounded
    
    FLOW SYSTEM UPDATES:
    ‚úÖ SECURE: 55% ($1,760) - Correct Flow percentage
    ‚úÖ SAVE: 5% ($160) - Long-term wealth building (Starting Out profile)
    ‚úÖ SPEND: 35% ($1,120) - "Starting Out" profile allocation
    ‚úÖ STASH: 5% ($160) - Correct Flow percentage
    ‚úÖ Daily Flow: $35 - Matches Flow methodology
    
    STABLE FEATURES:
    ‚úÖ Tab 1 (Guilt-Free Zone) - Complete with correct allocations & rounding
    ‚úÖ Tab 2 (Lightning-Fast Expense Entry) - Working with Flow math & rounding
    ‚úÖ Tab 3 (4 S's Budget System) - Proper SECURE, SAVE, STASH, SPEND categories
    ‚úÖ Cross-Tab Synchronization - Real-time updates across all tabs
    ‚úÖ AI Chat Integration - Contextual intelligence across tabs
    ‚úÖ 5-Tab Navigation - Smooth transitions with proper state management
    ‚úÖ Design Consistency - Exact colors and patterns preserved
    
    NEXT DEVELOPMENT:
    - Integrate calculateDaysRemaining() into updateDailyFlowCalculation()
    - Add user profile system (Starting Out, Getting Serious, Wealth Building)
    - Implement STASH auto-activation system
    - Tab 4: Analytics and insights dashboard
    - Tab 5: Settings and profile management
    -->
    
    <style>
        /* ===== CSS VARIABLES - EXACT REFERENCE COMPLIANCE ===== */
        :root {
            /* Background System */
            --dark-bg: #0f0f1a;
            
            /* Glass Effects */
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.06);
            
            /* 4 S's Category Gradients - EXACT FROM REFERENCE */
            --secure-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --save-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --spend-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --stash-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            
            /* Category Colors */
            --accent-red: #ef4444;
            --accent-amber: #f59e0b;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            
            /* Typography */
            --text-primary: #f8fafc;
            --text-secondary: rgba(248, 250, 252, 0.7);
            --text-muted: rgba(248, 250, 252, 0.5);
            
            /* Shadows & Effects */
            --shadow-subtle: 0 4px 16px rgba(99, 102, 241, 0.15);
            --shadow-medium: 0 8px 25px rgba(99, 102, 241, 0.2);
            --shadow-glow: 0 12px 32px rgba(16, 185, 129, 0.3);
            --shadow-ai: 0 12px 32px rgba(99, 102, 241, 0.4);
            
            /* Animation System */
            --animation-timing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== ANIMATED BACKGROUND ===== */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0f0f1a, #1a1a2e, #16213e, #1a1a2e);
            background-size: 400% 400%;
            animation: subtleGradientShift 25s ease infinite;
        }

        @keyframes subtleGradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ===== MAIN APP CONTAINER ===== */
        .app-container {
            max-width: 400px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* ===== TAB CONTENT SYSTEM ===== */
        .tab-content {
            padding: 20px;
            padding-bottom: 120px;
            min-height: 100vh;
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: slideInUp 0.5s var(--animation-timing);
        }

        @keyframes slideInUp {
            from { 
                transform: translateY(20px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }

        /* ===== SHARED GLASS CARD SYSTEM ===== */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-subtle);
            transition: all 0.3s var(--animation-timing);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* ===== LOADING STATES ===== */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            color: var(--text-secondary);
            font-size: 18px;
            gap: 16px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top: 3px solid var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== TAB 1: GUILT-FREE ZONE STYLES ===== */
        .hero-section {
            text-align: center;
            margin-bottom: 32px;
            animation: slideInDown 0.8s ease-out;
        }

        @keyframes slideInDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .daily-flow-display {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 32px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-glow);
            cursor: pointer;
            transition: all 0.3s var(--animation-timing);
            position: relative;
            overflow: hidden;
        }

        .daily-flow-display:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow);
        }

        .daily-flow-display:active {
            transform: scale(0.98);
        }

        .daily-flow-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .daily-flow-amount {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent-green);
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .daily-flow-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .celebration-pulse {
            animation: celebrationPulse 0.6s ease-out;
        }

        @keyframes celebrationPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 32px;
            animation: slideInUp 0.8s ease-out 0.2s both;
        }

        .action-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s var(--animation-timing);
            text-decoration: none;
            color: var(--text-primary);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .action-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .action-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ===== TAB 2: EXPENSE ENTRY STYLES ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding: 20px 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            animation: slideInDown 0.8s ease-out;
        }

        .header-info {
            flex: 1;
        }

        .tab-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quick-status {
            font-size: 14px;
            color: var(--accent-green);
            font-weight: 500;
        }

        /* Quick Add Grid */
        .quick-add-section {
            margin-bottom: 28px;
            animation: slideInUp 0.8s ease-out 0.1s both;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-add-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .quick-add-btn {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s var(--animation-timing);
            color: var(--text-primary);
        }

        .quick-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .quick-add-btn:active {
            transform: scale(0.98);
        }

        .quick-add-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .quick-add-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .quick-add-price {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* ===== TAB 3: 4 S'S BUDGET SYSTEM ===== */
        .budget-header {
            text-align: center;
            margin-bottom: 32px;
            animation: slideInDown 0.8s ease-out;
        }

        .budget-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .budget-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* Income Overview */
        .income-overview {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 28px;
            text-align: center;
            animation: slideInUp 0.8s ease-out 0.1s both;
        }

        .income-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .income-amount {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .income-period {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Budget Categories */
        .budget-flow {
            animation: slideInUp 0.8s ease-out 0.2s both;
        }

        .budget-category {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s var(--animation-timing);
            position: relative;
            overflow: hidden;
        }

        .budget-category:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .budget-category:active {
            transform: scale(0.99);
        }

        /* Category Headers */
        .category-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .category-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .secure .category-icon { background: var(--secure-gradient); }
        .save .category-icon { background: var(--save-gradient); }
        .spend .category-icon { background: var(--spend-gradient); }
        .stash .category-icon { background: var(--stash-gradient); }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .category-description {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        /* Category Amounts */
        .category-amount {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .secure .category-amount { color: var(--accent-red); }
        .save .category-amount { color: var(--accent-amber); }
        .spend .category-amount { color: var(--accent-green); }
        .stash .category-amount { color: var(--accent-blue); }

        /* Progress Bars */
        .progress-container {
            margin-bottom: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        .secure .progress-fill { background: var(--secure-gradient); }
        .save .progress-fill { background: var(--save-gradient); }
        .spend .progress-fill { background: var(--spend-gradient); }
        .stash .progress-fill { background: var(--stash-gradient); }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Allocation Examples */
        .allocation-examples {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            opacity: 0.8;
        }

        .example-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Daily Preview */
        .daily-preview {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border-radius: 20px;
            padding: 24px;
            margin-top: 32px;
            text-align: center;
            border: 1px solid var(--glass-border);
            animation: slideInUp 0.8s ease-out 0.3s both;
        }

        .daily-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .daily-amount {
            font-size: 36px;
            font-weight: 800;
            color: var(--accent-green);
            margin-bottom: 8px;
        }

        .daily-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .calculation-breakdown {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            font-size: 12px;
            color: var(--text-muted);
            text-align: left;
        }

        .calculation-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .calculation-line:last-child {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 8px;
            margin-top: 8px;
            font-weight: 600;
            color: var(--accent-green);
        }

        /* ===== NAVIGATION SYSTEM ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 20px 20px 0 0;
            padding: 16px 32px 20px;
            display: flex;
            gap: 8px;
            width: 100%;
            max-width: 400px;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            cursor: pointer;
            padding: 12px 8px;
            border-radius: 16px;
            transition: all 0.3s var(--animation-timing);
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 500;
            text-decoration: none;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
            display: block;
        }

        .nav-label {
            font-size: 10px;
        }

        /* ===== AI CHAT SYSTEM ===== */
        .ai-chat-toggle {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-ai);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s var(--animation-timing);
        }

        .ai-chat-toggle:hover {
            transform: scale(1.1);
        }

        .ai-chat-toggle:active {
            transform: scale(0.95);
        }

        .ai-chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .ai-chat-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ai-chat-container {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            width: 100%;
            max-width: 360px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            animation: slideInUp 0.3s ease-out;
        }

        .ai-chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .ai-chat-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .ai-chat-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 200px;
            max-height: 300px;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .ai-chat-input-container {
            padding: 20px;
            border-top: 1px solid var(--glass-border);
        }

        .ai-chat-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .ai-chat-input:focus {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .ai-chat-input::placeholder {
            color: var(--text-muted);
        }

        /* ===== TOAST NOTIFICATION SYSTEM ===== */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px 24px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            box-shadow: var(--shadow-medium);
            animation: slideInDown 0.5s ease-out;
            max-width: 320px;
            text-align: center;
        }

        .toast.success {
            border-color: rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.1);
        }

        .toast.warning {
            border-color: rgba(245, 158, 11, 0.3);
            background: rgba(245, 158, 11, 0.1);
        }

        /* ===== ROUNDING FEEDBACK STYLES ===== */
        .rounding-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            z-index: 3000;
            box-shadow: var(--shadow-medium);
            animation: slideInUp 0.3s ease-out;
            max-width: 280px;
            text-align: center;
        }

        .rounding-feedback .original-amount {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .rounding-feedback .rounded-amount {
            color: var(--accent-green);
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .rounding-feedback .explanation {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 380px) {
            .app-container {
                padding: 0 16px;
            }
            
            .quick-add-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        /* ===== HAPTIC FEEDBACK CLASSES ===== */
        .haptic-light {
            /* Triggers light haptic feedback via JavaScript */
        }

        .haptic-medium {
            /* Triggers medium haptic feedback via JavaScript */
        }

        .haptic-heavy {
            /* Triggers heavy haptic feedback via JavaScript */
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation"></div>

    <!-- Main App Container -->
    <div class="app-container">
        
        <!-- TAB 1: GUILT-FREE ZONE -->
        <div id="tab-guilt-free" class="tab-content active">
            <div class="hero-section">
                <div class="daily-flow-display" onclick="celebrateFlow()">
                    <div class="daily-flow-label">üíö Today's Guilt-Free Amount</div>
                    <div class="daily-flow-amount" id="daily-flow-amount">$35</div>
                    <div class="daily-flow-description">
                        This is YOUR money to enjoy guilt-free üéâ
                    </div>
                </div>
            </div>

            <!-- Quick Spend Actions -->
            <div class="quick-actions">
                <div class="action-btn haptic-medium" onclick="quickSpend(5, 'Coffee Run ‚òï')">
                    <span class="action-icon">‚òï</span>
                    <div class="action-label">Coffee Run</div>
                    <div class="action-desc">$5</div>
                </div>
                <div class="action-btn haptic-medium" onclick="quickSpend(15, 'Lunch Treat üçï')">
                    <span class="action-icon">üçï</span>
                    <div class="action-label">Lunch Treat</div>
                    <div class="action-desc">$15</div>
                </div>
                <div class="action-btn haptic-medium" onclick="quickSpend(5, 'Snack Attack üçø')">
                    <span class="action-icon">üçø</span>
                    <div class="action-label">Snack Attack</div>
                    <div class="action-desc">$5</div>
                </div>
                <div class="action-btn haptic-light" onclick="showCustomAmount()">
                    <span class="action-icon">üí≥</span>
                    <div class="action-label">Custom Amount</div>
                    <div class="action-desc">You choose!</div>
                </div>
            </div>

            <!-- Streak Display -->
            <div class="glass-card">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="font-size: 32px;">üî•</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 700;">5-Day Guilt-Free Streak!</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">You're absolutely crushing this budget thing ‚ú®</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: SPENDING ENTRY -->
        <div id="tab-spending" class="tab-content">
            <!-- Header with Daily Flow Display -->
            <header class="header">
                <div class="header-info">
                    <h1 class="tab-title">Add Spending üí∏</h1>
                    <p class="quick-status" id="tab2-daily-flow">$35 left guilt-free today!</p>
                </div>
                <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 8px 12px; font-size: 12px; color: var(--accent-green); font-weight: 600;">
                    ‚úÖ Pre-approved
                </div>
            </header>

            <!-- Lightning Fast Quick Add -->
            <div class="quick-add-section">
                <h2 class="section-title">‚ö° Lightning Quick Add</h2>
                <div class="quick-add-grid">
                    <div class="quick-add-btn haptic-medium" onclick="quickAdd('coffee', 5)">
                        <span class="quick-add-icon">‚òï</span>
                        <div class="quick-add-label">Coffee</div>
                        <div class="quick-add-price">$5</div>
                    </div>
                    <div class="quick-add-btn haptic-medium" onclick="quickAdd('lunch', 10)">
                        <span class="quick-add-icon">üçï</span>
                        <div class="quick-add-label">Lunch</div>
                        <div class="quick-add-price">$10</div>
                    </div>
                    <div class="quick-add-btn haptic-medium" onclick="quickAdd('snack', 5)">
                        <span class="quick-add-icon">üçø</span>
                        <div class="quick-add-label">Snack</div>
                        <div class="quick-add-price">$5</div>
                    </div>
                    <div class="quick-add-btn haptic-medium" onclick="quickAdd('gas', 40)">
                        <span class="quick-add-icon">‚õΩ</span>
                        <div class="quick-add-label">Gas</div>
                        <div class="quick-add-price">$40</div>
                    </div>
                    <div class="quick-add-btn haptic-medium" onclick="quickAdd('uber', 15)">
                        <span class="quick-add-icon">üöó</span>
                        <div class="quick-add-label">Ride</div>
                        <div class="quick-add-price">$15</div>
                    </div>
                    <div class="quick-add-btn haptic-medium" onclick="quickAdd('shopping', 25)">
                        <span class="quick-add-icon">üõçÔ∏è</span>
                        <div class="quick-add-label">Shopping</div>
                        <div class="quick-add-price">$25</div>
                    </div>
                </div>
                
                <!-- Custom Amount Button -->
                <button class="quick-add-btn haptic-light" onclick="showCustomAmount()" style="width: 100%; margin-top: 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; cursor: pointer; color: var(--text-primary); font-family: inherit;">
                    <span style="font-size: 24px; margin-bottom: 8px; display: block;">‚ûï</span>
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">Custom Amount</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Anything Goes!</div>
                </button>
            </div>

            <!-- Today's Activity -->
            <div class="glass-card">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    üìä Today's Activity
                </h3>
                <div id="todays-transactions">
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                        No spending today - your Daily Flow is fully available! üéâ
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 3: 4 S'S BUDGET SYSTEM -->
        <div id="tab-budget" class="tab-content">
            <!-- Budget Header -->
            <div class="budget-header">
                <h1 class="budget-title">üéØ Your Budget Flow</h1>
                <p class="budget-subtitle">The 4 S's that build your financial confidence</p>
            </div>

            <!-- Income Overview -->
            <div class="income-overview">
                <div class="income-label">Monthly Income</div>
                <div class="income-amount">$3,200</div>
                <div class="income-period">Working for your freedom ‚ú®</div>
            </div>

            <!-- The 4 S's Budget Categories -->
            <div class="budget-flow">
                
                <!-- SECURE -->
                <div class="budget-category secure" onclick="expandCategory('secure')">
                    <div class="category-header">
                        <div class="category-icon">üõ°Ô∏è</div>
                        <div class="category-info">
                            <div class="category-name">Secure</div>
                            <div class="category-description">Lock it down - untouchable recurring payments</div>
                        </div>
                    </div>
                    <div class="category-amount">$1,760</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>$1,760 allocated</span>
                            <span>55% of income</span>
                        </div>
                    </div>
                    <div class="allocation-examples">
                        <div class="example-item">üè† Rent: $1,200</div>
                        <div class="example-item">üì± Phone: $80</div>
                        <div class="example-item">üì∫ Netflix: $15</div>
                        <div class="example-item">üõ°Ô∏è Insurance: $385</div>
                    </div>
                </div>

                <!-- SAVE -->
                <div class="budget-category save" onclick="expandCategory('save')">
                    <div class="category-header">
                        <div class="category-icon">üí∞</div>
                        <div class="category-info">
                            <div class="category-name">Save</div>
                            <div class="category-description">Long-term wealth building - your future self</div>
                        </div>
                    </div>
                    <div class="category-amount">$160</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>$160 saved this month</span>
                            <span>5% of income</span>
                        </div>
                    </div>
                    <div class="allocation-examples">
                        <div class="example-item">üè¶ Emergency Fund: $80</div>
                        <div class="example-item">üìà Index Funds: $40</div>
                        <div class="example-item">üéØ Goal Savings: $30</div>
                        <div class="example-item">üîÆ Future You: $10</div>
                    </div>
                </div>

                <!-- SPEND -->
                <div class="budget-category spend" onclick="expandCategory('spend')">
                    <div class="category-header">
                        <div class="category-icon">üíö</div>
                        <div class="category-info">
                            <div class="category-name">Spend</div>
                            <div class="category-description">Live your life - 100% guilt-free zone!</div>
                        </div>
                    </div>
                    <div class="category-amount">$1,120</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>$735 enjoyed so far</span>
                            <span>35% of income</span>
                        </div>
                    </div>
                    <div class="allocation-examples">
                        <div class="example-item">‚òï Coffee: $150</div>
                        <div class="example-item">üçï Dining: $400</div>
                        <div class="example-item">üé¨ Entertainment: $185</div>
                        <div class="example-item">üõçÔ∏è Shopping: $485</div>
                    </div>
                </div>

                <!-- STASH -->
                <div class="budget-category stash" onclick="expandCategory('stash')">
                    <div class="category-header">
                        <div class="category-icon">üíé</div>
                        <div class="category-info">
                            <div class="category-name">Stash</div>
                            <div class="category-description">Future you - buffer &amp; emergency protection</div>
                        </div>
                    </div>
                    <div class="category-amount">$160</div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span>$160 protected</span>
                            <span>5% of income</span>
                        </div>
                    </div>
                    <div class="allocation-examples">
                        <div class="example-item">üõ°Ô∏è Emergency: $100</div>
                        <div class="example-item">üèñÔ∏è Vacation: $50</div>
                        <div class="example-item">üí∞ Buffer: $60</div>
                        <div class="example-item">üìà Investment: $30</div>
                    </div>
                </div>

            </div>

            <!-- Daily Spending Preview -->
            <div class="daily-preview">
                <h2 class="daily-title">üìÖ Your Daily Guilt-Free Amount</h2>
                <div class="daily-amount">$35</div>
                <div class="daily-description">This is what you can spend TODAY without any guilt or worry!</div>
                
                <!-- Calculation Breakdown -->
                <div class="calculation-breakdown">
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">How we calculate this:</div>
                    <div class="calculation-line">
                        <span>Spend category remaining:</span>
                        <span>$385</span>
                    </div>
                    <div class="calculation-line">
                        <span>Days left in month:</span>
                        <span>11 days</span>
                    </div>
                    <div class="calculation-line">
                        <span>Your daily freedom:</span>
                        <span>$35</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: INSIGHTS -->
        <div id="tab-insights" class="tab-content">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <div>‚ú® Building your insights dashboard...</div>
            </div>
        </div>

        <!-- TAB 5: SETTINGS -->
        <div id="tab-settings" class="tab-content">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <div>üë§ Setting up your profile...</div>
            
            <div class="glass-card">
                <button onclick="startFresh()" style="width: 100%; padding: 14px 20px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.08); color: white; border: none; border-radius: 12px; cursor: pointer;">
                    üîÑ Start Fresh with New Income
                </button>
            </div>

            <div class="glass-card">
                <button onclick="resetAppState()" style="width: 100%; padding: 14px 20px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.05); color: white; border: none; border-radius: 12px; cursor: pointer;">
                    üßπ Reset All App Data
                </button>
            </div>

            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" onclick="switchTab('guilt-free')">
            <span class="nav-icon">üíö</span>
            <span class="nav-label">Flow</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('spending')">
            <span class="nav-icon">üí∏</span>
            <span class="nav-label">Spend</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('budget')">
            <span class="nav-icon">üéØ</span>
            <span class="nav-label">Budget</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('insights')">
            <span class="nav-icon">‚ú®</span>
            <span class="nav-label">Insights</span>
        </a>
        <a href="#" class="nav-item" onclick="switchTab('settings')">
            <span class="nav-icon">üë§</span>
            <span class="nav-label">You</span>
        </a>
    </nav>

    <!-- AI Chat Toggle -->
    <button class="ai-chat-toggle haptic-medium" onclick="toggleAIChat()">
        ü§ñ
    </button>

    <!-- AI Chat Modal -->
    <div id="ai-chat-modal" class="ai-chat-modal">
        <div class="ai-chat-container">
            <div class="ai-chat-header">
                <h3 class="ai-chat-title">üí¨ Your Money Coach</h3>
                <button class="ai-chat-close" onclick="toggleAIChat()">√ó</button>
            </div>
            <div class="ai-chat-messages" id="ai-chat-messages">
                <div class="ai-message">
                    Hi! I'm your financial wellness assistant. I can see you have $35 available guilt-free today and you're building wealth with your SAVE category! How can I help? üíö
                </div>
            </div>
            <div class="ai-chat-input-container">
                <input type="text" class="ai-chat-input" placeholder="Ask about your budget..." id="ai-chat-input" onkeypress="handleAIChatInput(event)">
            </div>
        </div>
    </div>

    <script>
        // ===== UNIVERSAL MULTIPLES OF 5 ROUNDING SYSTEM =====
        function roundToNearestFive(amount) {
            return Math.round(amount / 5) * 5;
        }

        /**
         * Calculate remaining days in current month
         * Handles edge cases and ensures system stability
         * @returns {number} Days remaining (minimum 1 to prevent division by zero)
         */
        function calculateDaysRemaining() {
            const today = new Date();
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const daysLeft = endOfMonth.getDate() - today.getDate() + 1;
            
            // Enterprise safeguard: Minimum 1 day prevents division by zero
            // Gen Z UX: Ensures users always see positive daily flow on month-end
            return Math.max(1, daysLeft);
        }

        /**
         * Activates STASH emergency mode when SPEND category is depleted
         * Updates state and UI to reflect emergency fund availability
         */
        function activateStashMode() {
            // Calculate available STASH amount
            const stashCategory = appState.categories.stash;
            const stashAvailable = stashCategory.allocated - stashCategory.used;
            
            // Update app state
            appState.stashActivated = true;
            appState.stashAvailable = stashAvailable;
            
            // Calculate new daily flow using STASH
            const daysRemaining = calculateDaysRemaining();
            const stashDailyFlow = roundToNearestFive(stashAvailable / daysRemaining);
            
            // Update daily flow to STASH amount
            appState.dailyFlow = stashDailyFlow;
            
            // Update all displays
            updateDailyFlowDisplay();
            updateStashModeDisplays();
            
            console.log('üõ°Ô∏è STASH Emergency Mode Activated:', {
                stashAvailable: stashAvailable,
                stashDailyFlow: stashDailyFlow,
                daysRemaining: daysRemaining,
                activationTime: new Date().toISOString()
            });
        }

        /**
         * Updates UI elements to show STASH emergency mode
         */
        function updateStashModeDisplays() {
            // Update main daily flow display with emergency styling
            const dailyFlowDisplay = document.querySelector('.daily-flow-display');
            if (dailyFlowDisplay && appState.stashActivated) {
                dailyFlowDisplay.style.borderColor = 'rgba(245, 158, 11, 0.4)';
                dailyFlowDisplay.style.background = 'rgba(245, 158, 11, 0.1)';
            }
            
            // Update daily flow label to indicate emergency mode
            const dailyFlowLabel = document.querySelector('.daily-flow-label');
            if (dailyFlowLabel && appState.stashActivated) {
                dailyFlowLabel.textContent = 'üõ°Ô∏è Emergency STASH Available';
            }
            
            // Update Tab 2 status indicator
            const tab2Status = document.getElementById('tab2-daily-flow');
            if (tab2Status && appState.stashActivated) {
                tab2Status.textContent = `${appState.dailyFlow} emergency funds available!`;
                tab2Status.style.color = 'var(--accent-amber)';
            }
            
            // Update budget tab STASH category visual
            const stashCategory = document.querySelector('.budget-category.stash');
            if (stashCategory && appState.stashActivated) {
                stashCategory.style.borderColor = 'rgba(245, 158, 11, 0.4)';
                stashCategory.style.background = 'rgba(245, 158, 11, 0.05)';
            }
        }

        function showRoundingFeedback(originalAmount, roundedAmount) {
            if (originalAmount === roundedAmount) return;
            
            const feedback = document.createElement('div');
            feedback.className = 'rounding-feedback';
            feedback.innerHTML = `
                <div class="original-amount">You entered: $${originalAmount.toFixed(2)}</div>
                <div class="rounded-amount">$${roundedAmount}</div>
                <div class="explanation">Rounded to nearest $5 for simplicity ‚ú®</div>
            `;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 2000);
        }

        function handleAmountInput(inputValue) {
            const originalAmount = parseFloat(inputValue);
            if (isNaN(originalAmount) || originalAmount <= 0) {
                return null;
            }
            
            const roundedAmount = roundToNearestFive(originalAmount);
            
            if (originalAmount !== roundedAmount) {
                showRoundingFeedback(originalAmount, roundedAmount);
            }
            
            return roundedAmount;
        }

        // ===== APP STATE MANAGEMENT =====
        let appState = loadAppState() || {
            dailyFlow: 35,
            todaySpent: 0,
            monthlyIncome: 3200,
            categories: {
                secure: { allocated: 1760, used: 1680, percentage: 55 },
                save: { allocated: 160, used: 160, percentage: 5 },
                spend: { allocated: 1120, used: 735, percentage: 35 },
                stash: { allocated: 160, used: 40, percentage: 5 }
            },
            transactions: [],
            currentTab: 'guilt-free',
            aiChatOpen: false,
            stashActivated: false,
            stashAvailable: 0
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Flow Budgeting App v2.5.2-stash-activation-partial');
            console.log('üìä Updated app state with STASH auto-activation system (Steps 1-4):', appState);
            
            // Initialize STASH available amount
            appState.stashAvailable = appState.categories.stash.allocated - appState.categories.stash.used;
            
            updateDailyFlowCalculation();
            updateDailyFlowDisplay();
            updateTransactionsList();
            updateBudgetProgress();
            persistAppState();  // Save to localStorage
            
            console.log('‚úÖ v2.5.2 initialized - STASH auto-activation system partially implemented');
        });

        // ===== TAB NAVIGATION SYSTEM =====
        function switchTab(tabName) {
            triggerHaptic('light');
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');
            
            appState.currentTab = tabName;
            
            if (tabName === 'budget') {
                initializeBudgetTab();
            }
        }

        // ===== TAB 3: BUDGET SYSTEM FUNCTIONALITY =====
        function initializeBudgetTab() {
            updateBudgetProgress();
            persistAppState();  // Save to localStorage
            updateDailyFlowCalculation();
            console.log('‚úÖ Tab 3 initialized with proper SAVE category (wealth building focus)');
        }

        function updateBudgetProgress() {
            const categories = ['secure', 'save', 'spend', 'stash'];
            
            categories.forEach(categoryName => {
                const category = appState.categories[categoryName];
                const progressPercent = Math.min((category.used / category.allocated) * 100, 100);
                
                const categoryElement = document.querySelector(`.budget-category.${categoryName}`);
                if (categoryElement) {
                    const progressFill = categoryElement.querySelector('.progress-fill');
                    if (progressFill) {
                        progressFill.style.width = `${progressPercent}%`;
                        console.log(`‚úÖ Updated ${categoryName} progress bar to ${progressPercent.toFixed(1)}%`);
                    }
                    
                    const progressText = categoryElement.querySelector('.progress-text');
                    if (progressText) {
                        const usedAmount = roundToNearestFive(category.used);
                        const allocatedAmount = roundToNearestFive(category.allocated);
                        
                        if (categoryName === 'secure') {
                            progressText.innerHTML = `
                                <span>$${allocatedAmount} allocated</span>
                                <span>${category.percentage}% of income</span>
                            `;
                        } else if (categoryName === 'save') {
                            progressText.innerHTML = `
                                <span>$${usedAmount} saved this month</span>
                                <span>${category.percentage}% of income</span>
                            `;
                        } else if (categoryName === 'spend') {
                            progressText.innerHTML = `
                                <span>$${usedAmount} enjoyed so far</span>
                                <span>${category.percentage}% of income</span>
                            `;
                        } else if (categoryName === 'stash') {
                            if (appState.stashActivated) {
                                progressText.innerHTML = `
                                    <span>${usedAmount} emergency used</span>
                                    <span>${category.percentage}% of income</span>
                                `;
                            } else {
                                progressText.innerHTML = `
                                    <span>${allocatedAmount} protected</span>
                                    <span>${category.percentage}% of income</span>
                                `;
                            }
                        }
                        console.log(`‚úÖ Updated ${categoryName} text: $${usedAmount} of $${allocatedAmount} (rounded)`);
                    }
                }
            });
            
            console.log('‚úÖ All budget progress bars updated with proper SAVE category (wealth building)');
        }

        function expandCategory(categoryType) {
            triggerHaptic('medium');
            console.log(`Expanding category: ${categoryType}`);
            if (categoryType === 'save') {
                showToast(`üí∞ SAVE category - Building your wealth one dollar at a time!`, 'success');
            } else {
                showToast(`üìä ${categoryType} details coming soon!`, 'success');
            }
        }

        function updateDailyFlowCalculation() {
            const spendAllocated = appState.categories.spend.allocated;
            const spendUsed = appState.categories.spend.used;
            const actualSpendRemaining = spendAllocated - spendUsed;
            
            // CRITICAL: Check for STASH activation BEFORE Math.max
            if (actualSpendRemaining <= 0 && !appState.stashActivated) {
                activateStashMode();
                showToast('üõ°Ô∏è Emergency mode: STASH funds now available', 'warning');
                return; // Exit early - activateStashMode handles the calculation
            }
            
            // Normal calculation for positive SPEND remaining
            const spendRemaining = Math.max(0, actualSpendRemaining);
            const daysRemaining = calculateDaysRemaining();
            const rawDailyFlow = Math.max(0, spendRemaining / daysRemaining);
            const newDailyFlow = roundToNearestFive(rawDailyFlow);
            
            appState.dailyFlow = newDailyFlow;
            updateDailyFlowDisplay();
            
            const dailyAmountElement = document.querySelector('.daily-preview .daily-amount');
            if (dailyAmountElement) {
                dailyAmountElement.textContent = `${newDailyFlow}`;
            }
            
            const calculationBreakdown = document.querySelector('.calculation-breakdown');
            if (calculationBreakdown) {
                calculationBreakdown.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">How we calculate this:</div>
                    <div class="calculation-line">
                        <span>Spend category remaining:</span>
                        <span>${roundToNearestFive(spendRemaining)}</span>
                    </div>
                    <div class="calculation-line">
                        <span>Days left in month:</span>
                        <span>${daysRemaining} days</span>
                    </div>
                    <div class="calculation-line">
                        <span>Your daily freedom:</span>
                        <span>${newDailyFlow}</span>
                    </div>
                `;
            }
            
            // Enhanced logging with STASH status
            console.log('üßÆ Daily Flow Calculation (STASH-aware):', {
                spendAllocated: spendAllocated,
                spendUsed: spendUsed,
                actualSpendRemaining: actualSpendRemaining,
                spendRemaining: spendRemaining,
                daysRemaining: daysRemaining,
                rawDailyFlow: rawDailyFlow.toFixed(2),
                roundedDailyFlow: newDailyFlow,
                stashActivated: appState.stashActivated
            });
            
            console.log('‚úÖ Daily flow recalculated with SAVE category focus');
        }

        // ===== QUICK SPENDING ACTIONS (TAB 1) =====
        function quickSpend(amount, description) {
            triggerHaptic('medium');
            
            const roundedAmount = roundToNearestFive(amount);
            
            console.log(`üí∏ Processing purchase: ${description} for $${roundedAmount} (rounded from $${amount})`);
            console.log('üìä Before purchase - Spend category:', appState.categories.spend);
            
            appState.todaySpent += roundedAmount;

            // Determine which category to charge based on STASH activation
            let targetCategory = 'spend';
            if (appState.stashActivated) {
                appState.categories.stash.used += roundedAmount;
                targetCategory = 'stash';
                console.log('üìä After purchase - STASH category:', appState.categories.stash);
            } else {
                appState.categories.spend.used += roundedAmount;
                console.log('üìä After purchase - Spend category:', appState.categories.spend);
            }
            
            // Update STASH available amount and daily flow when STASH is used
            if (appState.stashActivated) {
                const newStashAvailable = appState.categories.stash.allocated - appState.categories.stash.used;
                appState.stashAvailable = newStashAvailable;
                
                // Recalculate daily flow with updated STASH balance
                const daysRemaining = calculateDaysRemaining();
                appState.dailyFlow = roundToNearestFive(Math.max(0, newStashAvailable / daysRemaining));
                
                console.log('üìä STASH Balance Updated:', {
                    stashUsed: appState.categories.stash.used,
                    stashAvailable: newStashAvailable,
                    newDailyFlow: appState.dailyFlow
                });
                
                // STASH depletion warnings
                if (appState.stashAvailable <= 20 && appState.stashAvailable > 0) {
                    showToast('üö® CRITICAL: Emergency funds running low', 'warning');
                } else if (appState.stashAvailable <= 0) {
                    showToast('üö® EMERGENCY: All funds depleted', 'warning');
                    appState.dailyFlow = 0;
                }
            }
            
            const transaction = {
                id: Date.now(),
                amount: roundedAmount,
                description: description,
                timestamp: new Date(),
                category: targetCategory
            };
            appState.transactions.unshift(transaction);
            
            updateDailyFlowCalculation();
            updateTransactionsList();
            updateBudgetProgress();
            persistAppState();  // Save to localStorage
            
            if (appState.dailyFlow >= 0) {
                showToast(`üéâ ${description} - Guilt-free purchase confirmed!`, 'success');
            } else {
                showToast(`üíõ ${description} - Using tomorrow's flow, totally fine!`, 'warning');
            }
            
            celebrateFlow();
        }

        // ===== QUICK ADD ACTIONS (TAB 2) =====
        function quickAdd(type, amount) {
            triggerHaptic('medium');
            
            const descriptions = {
                coffee: 'Coffee ‚òï',
                lunch: 'Lunch üçï', 
                snack: 'Snack üçø',
                gas: 'Gas ‚õΩ',
                uber: 'Ride üöó',
                shopping: 'Shopping üõçÔ∏è'
            };
            
            quickSpend(amount, descriptions[type] || 'Purchase');
        }

        // ===== DISPLAY UPDATES =====
        function updateDailyFlowDisplay() {
            const flowAmount = Math.max(0, appState.dailyFlow);
            
            const tab1Display = document.getElementById('daily-flow-amount');
            if (tab1Display) {
                tab1Display.textContent = `$${flowAmount}`;
            }
            
            const tab2Display = document.getElementById('tab2-daily-flow');
            if (tab2Display) {
                tab2Display.textContent = `$${flowAmount} left guilt-free today!`;
            }
        }

        function updateTransactionsList() {
            const container = document.getElementById('todays-transactions');
            if (!container) return;
            
            if (appState.transactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                        No spending today - your Daily Flow is fully available! üéâ
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appState.transactions.map(transaction => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <div>
                        <div style="font-weight: 600;">${transaction.description}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${transaction.timestamp.toLocaleTimeString()}</div>
                    </div>
                    <div style="font-weight: 700; color: var(--accent-green);">$${transaction.amount}</div>
                </div>
            `).join('');
        }

        // ===== CELEBRATION SYSTEM =====
        function celebrateFlow() {
            triggerHaptic('light');
            const display = document.querySelector('.daily-flow-display');
            if (display) {
                display.classList.add('celebration-pulse');
                setTimeout(() => {
                    display.classList.remove('celebration-pulse');
                }, 600);
            }
        }

        function showCustomAmount() {
            triggerHaptic('light');
            const input = prompt('Enter custom amount:');
            if (input && input.trim()) {
                const processedAmount = handleAmountInput(input);
                if (processedAmount && processedAmount > 0) {
                    quickSpend(processedAmount, `Custom Purchase üí≥ ($${processedAmount})`);
                } else {
                    showToast('Please enter a valid amount greater than 0', 'warning');
                }
            }
        }

        // ===== AI CHAT SYSTEM =====
        function toggleAIChat() {
            triggerHaptic('medium');
            const modal = document.getElementById('ai-chat-modal');
            appState.aiChatOpen = !appState.aiChatOpen;
            
            if (appState.aiChatOpen) {
                modal.classList.add('active');
                document.getElementById('ai-chat-input').focus();
            } else {
                modal.classList.remove('active');
            }
        }

        function handleAIChatInput(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('ai-chat-input');
                const message = input.value.trim();
                
                if (message) {
                    addAIMessage(`You: ${message}`, 'user');
                    input.value = '';
                    
                    setTimeout(() => {
                        generateAIResponse(message);
                    }, 1000);
                }
            }
        }

        function addAIMessage(message, type = 'ai') {
            const container = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function generateAIResponse(userMessage) {
            const responses = [
                `I see you have $${appState.dailyFlow} available guilt-free today. You're doing great! üíö`,
                `Your SAVE category is building wealth at ${Math.round((appState.categories.save.used / appState.categories.save.allocated) * 100)}% - future you will thank you! üè¶`,
                `I love how everything rounds to multiples of $5 - so much simpler for decision-making! ‚ú®`,
                `Your Flow system is perfectly balanced: SECURE essentials covered, SAVE building wealth, guilt-free SPEND ready! üöÄ`
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addAIMessage(randomResponse);
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ===== HAPTIC FEEDBACK =====
        function triggerHaptic(intensity = 'light') {
            if (navigator.vibrate) {
                const patterns = {
                    light: [10],
                    medium: [20],
                    heavy: [30]
                };
                navigator.vibrate(patterns[intensity] || patterns.light);
            }
        }

        
        // ===== LOCALSTORAGE PERSISTENCE SYSTEM =====

        function startFresh() {
            const input = prompt("Enter your new monthly income (must be a number):", "3200");
            const income = parseInt(input);
            if (isNaN(income) || income < 100) {
                alert("Please enter a valid number greater than 100.");
                return;
            }

            const securePercentage = parseFloat(prompt("Enter SECURE % (e.g., 55)", "55"));
            const savePercentage = parseFloat(prompt("Enter SAVE % (e.g., 5)", "5"));
            const stashPercentage = parseFloat(prompt("Enter STASH % (e.g., 5)", "5"));

            const totalPercent = securePercentage + savePercentage + stashPercentage;
            if (
                isNaN(securePercentage) || isNaN(savePercentage) || isNaN(stashPercentage) ||
                totalPercent >= 100 || securePercentage < 0 || savePercentage < 0 || stashPercentage < 0
            ) {
                alert("Invalid input. Ensure all values are positive and the total is less than 100%.");
                return;
            }

            const spendPercentage = 100 - totalPercent;

            const secure = Math.round(income * (securePercentage / 100) / 5) * 5;
            const save = Math.round(income * (savePercentage / 100) / 5) * 5;
            const stash = Math.round(income * (stashPercentage / 100) / 5) * 5;
            const spend = income - secure - save - stash;

            appState = {
                dailyFlow: 0,
                todaySpent: 0,
                monthlyIncome: income,
                categories: {
                    secure: { allocated: secure, used: 0, percentage: securePercentage },
                    save: { allocated: save, used: save, percentage: savePercentage },
                    spend: { allocated: spend, used: 0, percentage: spendPercentage },
                    stash: { allocated: stash, used: 0, percentage: stashPercentage }
                },
                transactions: [],
                currentTab: 'guilt-free',
                aiChatOpen: false,
                stashActivated: false,
                stashAvailable: stash
            };

            persistAppState();
            updateDailyFlowCalculation();
            updateDailyFlowDisplay();
            updateTransactionsList();
            updateBudgetProgress();
            showToast("‚úÖ Budget reset with $" + income + " income and custom allocations", "success");
        }


        function startFresh() {
            const input = prompt("Enter your new monthly income (must be a number):", "3200");
            const income = parseInt(input);
            if (isNaN(income) || income < 100) {
                alert("Please enter a valid number greater than 100.");
                return;
            }

            const savePercentage = 5;
            const stashPercentage = 5;
            const securePercentage = 55;
            const spendPercentage = 100 - savePercentage - stashPercentage - securePercentage;

            const secure = Math.round(income * (securePercentage / 100) / 5) * 5;
            const save = Math.round(income * (savePercentage / 100) / 5) * 5;
            const stash = Math.round(income * (stashPercentage / 100) / 5) * 5;
            const spend = income - secure - save - stash;

            appState = {
                dailyFlow: 0,
                todaySpent: 0,
                monthlyIncome: income,
                categories: {
                    secure: { allocated: secure, used: 0, percentage: securePercentage },
                    save: { allocated: save, used: save, percentage: savePercentage },
                    spend: { allocated: spend, used: 0, percentage: spendPercentage },
                    stash: { allocated: stash, used: 0, percentage: stashPercentage }
                },
                transactions: [],
                currentTab: 'guilt-free',
                aiChatOpen: false,
                stashActivated: false,
                stashAvailable: stash
            };

            persistAppState();
            updateDailyFlowCalculation();
            updateDailyFlowDisplay();
            updateTransactionsList();
            updateBudgetProgress();
            showToast("‚úÖ New budget set based on $" + income + " income", "success");
        }

        function persistAppState() {
            try {
                localStorage.setItem('flowAppState', JSON.stringify(appState));
            } catch (e) {
                console.error('‚ùå Failed to save state to localStorage:', e);
            }
        }

        function loadAppState() {
            try {
                const saved = localStorage.getItem('flowAppState');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    console.log('‚úÖ Loaded app state from localStorage:', parsed);
                    return parsed;
                }
            } catch (e) {
                console.error('‚ö†Ô∏è Failed to load state from localStorage:', e);
            }
            return null;
        }

        function resetAppState() {
            if (confirm('Are you sure you want to clear all saved data and reload?')) {
                localStorage.removeItem('flowAppState');
                location.reload();
            }
        }


        // ===== ERROR HANDLING =====
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('App Error:', {
                message: msg,
                source: url,
                line: lineNo,
                column: columnNo,
                error: error
            });
            
            showToast('Something went wrong. Please refresh the app.', 'warning');
            return false;
        };
    </script>
</body>
</html>